VERSION 5.00
Object = "{6A24B331-7634-11D3-A5B0-0050044A7E1A}#1.5#0"; "DXDBGRID.DLL"
Object = "{03F7CB5F-9E40-4B74-A3ED-7DBEAAB01C6C}#1.0#0"; "ABOX.OCX"
Object = "{0BA686C6-F7D3-101A-993E-0000C0EF6F5E}#1.0#0"; "THREED32.OCX"
Object = "{F7E69521-3C28-11D2-B3E7-00AA00B42B7C}#3.1#0"; "FPTAB30.OCX"
Object = "{1BE65FA0-CBF9-11D2-BBC7-00104B9E0792}#2.0#0"; "SSTBARS2.OCX"
Begin VB.Form vale_ingreso 
   Caption         =   "Vale de Ingreso"
   ClientHeight    =   7515
   ClientLeft      =   510
   ClientTop       =   1005
   ClientWidth     =   11205
   BeginProperty Font 
      Name            =   "Arial"
      Size            =   8.25
      Charset         =   0
      Weight          =   400
      Underline       =   0   'False
      Italic          =   0   'False
      Strikethrough   =   0   'False
   EndProperty
   LinkTopic       =   "Form1"
   LockControls    =   -1  'True
   ScaleHeight     =   7515
   ScaleWidth      =   11205
   Begin TabproADOLib.fpTabProADO fpTabProADO1 
      Height          =   7395
      Left            =   45
      TabIndex        =   18
      Top             =   45
      Width           =   11130
      _Version        =   196609
      _ExtentX        =   19632
      _ExtentY        =   13044
      _StockProps     =   100
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
         Name            =   "MS Sans Serif"
         Size            =   8.25
         Charset         =   0
         Weight          =   400
         Underline       =   0   'False
         Italic          =   0   'False
         Strikethrough   =   0   'False
      EndProperty
      TabsPerRow      =   0
      TabCount        =   1
      AlignTextH      =   1
      AlignTextV      =   1
      ThreeD          =   -1  'True
      ShowFocusRect   =   0   'False
      ApplyTo         =   2
      ActiveTabBold   =   0   'False
      OffsetFromClientTop=   -1  'True
      ChamferedWidth  =   2
      ChamferedHeight =   2
      ShowEarMark     =   -1  'True
      BookShowMetalSpine=   -1  'True
      BookRingShowHole=   -1  'True
      DataFormat      =   ""
      BookCornerGuardWidth=   105
      BookCornerGuardLength=   405
      ThreeDInnerWidthActive=   1
      ActiveTabInflate=   2
      DrawFocusRect   =   1
      DataField       =   ""
      DataMember      =   ""
      TabCaption      =   "vale_ingreso.frx":0000
      PageEarMarkPictureNext=   "vale_ingreso.frx":044D
      PageEarMarkPicturePrev=   "vale_ingreso.frx":0469
      EarMarkPictureNext=   "vale_ingreso.frx":0485
      EarMarkPicturePrev=   "vale_ingreso.frx":04A1
      Begin Threed.SSPanel SSPanel6 
         Height          =   465
         Left            =   7815
         TabIndex        =   22
         Top             =   420
         Width           =   3165
         _Version        =   65536
         _ExtentX        =   5583
         _ExtentY        =   820
         _StockProps     =   15
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   1
         Begin VB.TextBox txtnumero 
            Alignment       =   2  'Center
            BackColor       =   &H80000004&
            Height          =   285
            Left            =   1800
            TabIndex        =   17
            Top             =   90
            Width           =   1050
         End
         Begin VB.Label Label8 
            AutoSize        =   -1  'True
            Caption         =   "Nº Vale"
            BeginProperty Font 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   700
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            Height          =   210
            Left            =   405
            TabIndex        =   23
            Top             =   135
            Width           =   570
         End
      End
      Begin Threed.SSPanel SSPanel1 
         Height          =   465
         Left            =   180
         TabIndex        =   20
         Top             =   420
         Width           =   7470
         _Version        =   65536
         _ExtentX        =   13176
         _ExtentY        =   820
         _StockProps     =   15
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         BevelOuter      =   0
         Begin ActiveToolBars.SSActiveToolBars SSActiveToolBars1 
            Left            =   45
            Top             =   0
            _ExtentX        =   741
            _ExtentY        =   741
            _Version        =   131082
            ToolBarsCount   =   1
            ToolsCount      =   5
            Tools           =   "vale_ingreso.frx":04BD
            ToolBars        =   "vale_ingreso.frx":4405
         End
      End
      Begin Threed.SSFrame SSFrame1 
         Height          =   3345
         Left            =   180
         TabIndex        =   19
         Top             =   900
         Width           =   10815
         _Version        =   65536
         _ExtentX        =   19076
         _ExtentY        =   5900
         _StockProps     =   14
         BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
            Name            =   "MS Sans Serif"
            Size            =   8.25
            Charset         =   0
            Weight          =   400
            Underline       =   0   'False
            Italic          =   0   'False
            Strikethrough   =   0   'False
         EndProperty
         Begin Threed.SSCommand cmdoc 
            Height          =   375
            Left            =   8280
            TabIndex        =   42
            Top             =   1350
            Width           =   1545
            _Version        =   65536
            _ExtentX        =   2725
            _ExtentY        =   661
            _StockProps     =   78
            Caption         =   "O/Compra"
         End
         Begin VB.ComboBox cmbmoneda 
            Height          =   330
            ItemData        =   "vale_ingreso.frx":4545
            Left            =   9300
            List            =   "vale_ingreso.frx":454F
            Style           =   2  'Dropdown List
            TabIndex        =   8
            Top             =   960
            Width           =   1380
         End
         Begin VB.TextBox txtconcepto 
            Enabled         =   0   'False
            Height          =   315
            Left            =   3720
            TabIndex        =   4
            Top             =   540
            Width           =   495
         End
         Begin VB.TextBox txtalmacen 
            Enabled         =   0   'False
            Height          =   330
            Left            =   3720
            TabIndex        =   1
            Top             =   180
            Width           =   495
         End
         Begin VB.ComboBox cmbconcepto 
            Height          =   330
            Left            =   1125
            Style           =   2  'Dropdown List
            TabIndex        =   3
            Top             =   540
            Width           =   2475
         End
         Begin VB.ComboBox cmbalmacen 
            Height          =   330
            Left            =   1125
            Style           =   2  'Dropdown List
            TabIndex        =   0
            Top             =   180
            Width           =   2490
         End
         Begin VB.TextBox txtobserva 
            Height          =   495
            Left            =   1620
            MaxLength       =   150
            MultiLine       =   -1  'True
            TabIndex        =   15
            Top             =   2745
            Width           =   9060
         End
         Begin VB.ComboBox cmbtipo 
            Height          =   330
            ItemData        =   "vale_ingreso.frx":4563
            Left            =   5310
            List            =   "vale_ingreso.frx":4565
            Style           =   2  'Dropdown List
            TabIndex        =   12
            Top             =   2340
            Width           =   2490
         End
         Begin VB.TextBox txtserfac 
            Height          =   315
            Left            =   8145
            MaxLength       =   3
            TabIndex        =   13
            Top             =   2385
            Width           =   510
         End
         Begin VB.TextBox txtnumfac 
            Height          =   315
            Left            =   8685
            MaxLength       =   7
            TabIndex        =   14
            Top             =   2385
            Width           =   1095
         End
         Begin VB.TextBox txtserie 
            Height          =   315
            Left            =   1620
            MaxLength       =   3
            TabIndex        =   10
            Top             =   2385
            Width           =   510
         End
         Begin VB.TextBox txtnumdoc 
            Height          =   315
            Left            =   2160
            MaxLength       =   7
            TabIndex        =   11
            Top             =   2385
            Width           =   1095
         End
         Begin VB.TextBox txtccosto 
            Height          =   315
            Left            =   1125
            MaxLength       =   8
            TabIndex        =   7
            Top             =   1305
            Width           =   1095
         End
         Begin VB.TextBox txttc 
            Alignment       =   1  'Right Justify
            Height          =   315
            Left            =   9315
            MaxLength       =   11
            TabIndex        =   5
            Text            =   "0.000"
            Top             =   585
            Visible         =   0   'False
            Width           =   1320
         End
         Begin VB.TextBox txtproveedor 
            Height          =   315
            Left            =   1125
            MaxLength       =   11
            TabIndex        =   6
            Top             =   945
            Width           =   1095
         End
         Begin aBoxCtl.aBox abofecha 
            Height          =   315
            Left            =   9315
            TabIndex        =   2
            Top             =   225
            Width           =   1320
            _ExtentX        =   2328
            _ExtentY        =   556
            ABoxType        =   ""
            MinValue        =   "D01000101"
            MaxValue        =   "D99991231"
            ABoxStyle       =   2
            Alignment       =   1
            AlignmentVertical=   2
            HideSelection   =   -1  'True
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            BeginProperty FocusFont {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ApplyTextFormat =   -1  'True
            TextFormat      =   "dd/mm/yyyy"
            Text            =   "26/12/2005"
            DateFormat      =   "dd/mm/yyyy"
            FocusDateFormat =   1
            NegativeForeColor=   255
            NumberFormat    =   17
            DecimalPlaces   =   0
            HotAppearance   =   2
            CalendarTrailingForeColor=   -2147483629
            BeginProperty CalendarFont {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            ShowButton      =   1
            ButtonPicture   =   "vale_ingreso.frx":4567
            ButtonWidth     =   21
            UpDownWidth     =   14
            NullText        =   ""
            BeginProperty CalcBtnFont {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            BeginProperty CalcDisplayFont {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "MS Sans Serif"
               Size            =   8.25
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            CalcBtnHotStyle =   4
            CalcBackColor   =   -2147483643
            CalcBtnBackColor=   -2147483643
            CalcBtnDigitColor=   -2147483646
            CalcBtnFuntionColor=   8388736
            CalcDisplayFrameColor=   65535
            CalcHeaderBackColor=   -2147483646
         End
         Begin Threed.SSPanel pnlproveedor 
            Height          =   315
            Left            =   2295
            TabIndex        =   27
            Top             =   945
            Width           =   5505
            _Version        =   65536
            _ExtentX        =   9710
            _ExtentY        =   556
            _StockProps     =   15
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.26
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            BevelOuter      =   1
         End
         Begin Threed.SSPanel pnlccosto 
            Height          =   315
            Left            =   2295
            TabIndex        =   30
            Top             =   1305
            Width           =   5505
            _Version        =   65536
            _ExtentX        =   9710
            _ExtentY        =   556
            _StockProps     =   15
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.26
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            BevelOuter      =   1
         End
         Begin VB.ComboBox cmbmarca 
            Height          =   330
            Left            =   1125
            Style           =   2  'Dropdown List
            TabIndex        =   41
            Top             =   1680
            Visible         =   0   'False
            Width           =   6645
         End
         Begin Threed.SSCommand cmdimporta 
            Height          =   330
            Left            =   8280
            TabIndex        =   45
            Top             =   1755
            Visible         =   0   'False
            Width           =   1545
            _Version        =   65536
            _ExtentX        =   2725
            _ExtentY        =   582
            _StockProps     =   78
            Caption         =   "Importación"
         End
         Begin Threed.SSPanel pnluupp 
            Height          =   315
            Left            =   2295
            TabIndex        =   38
            Top             =   1665
            Visible         =   0   'False
            Width           =   5505
            _Version        =   65536
            _ExtentX        =   9710
            _ExtentY        =   556
            _StockProps     =   15
            BeginProperty Font {0BE35203-8F91-11CE-9DE3-00AA004BB851} 
               Name            =   "Arial"
               Size            =   8.26
               Charset         =   0
               Weight          =   400
               Underline       =   0   'False
               Italic          =   0   'False
               Strikethrough   =   0   'False
            EndProperty
            BevelOuter      =   1
         End
         Begin VB.TextBox txtuupp 
            Height          =   315
            Left            =   1125
            MaxLength       =   8
            TabIndex        =   9
            Top             =   1665
            Visible         =   0   'False
            Width           =   1095
         End
         Begin VB.Label Label16 
            AutoSize        =   -1  'True
            Caption         =   "Importación"
            Height          =   210
            Left            =   9945
            TabIndex        =   44
            Top             =   2295
            Visible         =   0   'False
            Width           =   825
         End
         Begin VB.Label lbloc 
            AutoSize        =   -1  'True
            Caption         =   "O/Compra"
            Height          =   210
            Left            =   9855
            TabIndex        =   43
            Top             =   2115
            Visible         =   0   'False
            Width           =   720
         End
         Begin VB.Label Label9 
            AutoSize        =   -1  'True
            Caption         =   "Moneda"
            Height          =   210
            Left            =   8280
            TabIndex        =   40
            Top             =   1005
            Width           =   570
         End
         Begin VB.Label Label11 
            AutoSize        =   -1  'True
            Caption         =   "Observaciones"
            Height          =   210
            Left            =   180
            TabIndex        =   37
            Top             =   2745
            Width           =   1110
         End
         Begin VB.Label Label14 
            AutoSize        =   -1  'True
            Caption         =   "Número"
            Height          =   210
            Left            =   8910
            TabIndex        =   36
            Top             =   2160
            Width           =   555
         End
         Begin VB.Label Label13 
            AutoSize        =   -1  'True
            Caption         =   "Serie"
            Height          =   210
            Left            =   8190
            TabIndex        =   35
            Top             =   2160
            Width           =   375
         End
         Begin VB.Label Label10 
            AutoSize        =   -1  'True
            Caption         =   "Número"
            Height          =   210
            Left            =   2385
            TabIndex        =   34
            Top             =   2115
            Width           =   555
         End
         Begin VB.Label Label6 
            AutoSize        =   -1  'True
            Caption         =   "Serie"
            Height          =   210
            Left            =   1665
            TabIndex        =   33
            Top             =   2115
            Width           =   375
         End
         Begin VB.Label Label2 
            AutoSize        =   -1  'True
            Caption         =   "Tipo Doc."
            Height          =   210
            Left            =   4500
            TabIndex        =   32
            Top             =   2385
            Width           =   675
         End
         Begin VB.Label Label12 
            AutoSize        =   -1  'True
            Caption         =   "Guía de Remisión"
            Height          =   210
            Left            =   180
            TabIndex        =   31
            Top             =   2385
            Width           =   1245
         End
         Begin VB.Label Label7 
            AutoSize        =   -1  'True
            Caption         =   "C. Costo"
            Height          =   210
            Left            =   225
            TabIndex        =   29
            Top             =   1350
            Width           =   615
         End
         Begin VB.Label Label3 
            AutoSize        =   -1  'True
            Caption         =   "T/C"
            Height          =   210
            Left            =   8280
            TabIndex        =   28
            Top             =   630
            Visible         =   0   'False
            Width           =   240
         End
         Begin VB.Label lblproveedor 
            AutoSize        =   -1  'True
            Caption         =   "Proveedor"
            Height          =   210
            Left            =   225
            TabIndex        =   26
            Top             =   990
            Width           =   750
         End
         Begin VB.Label Label4 
            Caption         =   "Fecha"
            Height          =   195
            Left            =   8280
            TabIndex        =   25
            Top             =   315
            Width           =   555
         End
         Begin VB.Label Label1 
            AutoSize        =   -1  'True
            Caption         =   "Concepto"
            Height          =   210
            Left            =   225
            TabIndex        =   24
            Top             =   630
            Width           =   690
         End
         Begin VB.Label Label5 
            Caption         =   "Almacén"
            Height          =   195
            Left            =   225
            TabIndex        =   21
            Top             =   270
            Width           =   645
         End
         Begin VB.Label lbluupp 
            AutoSize        =   -1  'True
            Caption         =   "UUPP"
            Height          =   210
            Left            =   225
            TabIndex        =   39
            Top             =   1755
            Visible         =   0   'False
            Width           =   390
         End
      End
      Begin DXDBGRIDLibCtl.dxDBGrid dxDBGrid1 
         Height          =   2910
         Left            =   180
         OleObjectBlob   =   "vale_ingreso.frx":48B9
         TabIndex        =   16
         Top             =   4320
         Width           =   10815
      End
   End
End
Attribute VB_Name = "vale_ingreso"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False
Dim sw_activate         As Boolean
Dim cconex_form         As String
Dim wpartida            As String
Dim sw_ayuda            As Boolean
Dim sw_nuevo_item       As Boolean
Dim cnombase            As String
Dim cnomtabla           As String
Dim Values()            As Variant
Dim amovs_cab(0 To 17)  As a_grabacion
Dim amovs_det(0 To 12)  As a_grabacion
Dim ctipo               As String * 1
Dim cvalores            As String
Dim cmes                As String * 2
Dim RSDETALLE           As New ADODB.Recordset
Dim nfil                As Integer
Dim sw_cabecera         As Boolean
Dim sw_detalle          As Boolean
Dim sw_ayuda_prod       As Boolean
Dim rs                  As New ADODB.Recordset
Dim rst                 As New ADODB.Recordset
Dim i                   As Integer
Dim wopcion             As Byte

Private Sub IMPRIMIR_VALES()
Dim csql            As String
Dim CSQL1           As String
Dim Csql2           As String
Dim Csql3           As String
Dim prov            As String
Dim costo           As String
Dim RegEmpresa      As New ADODB.Recordset
Dim RegCosto        As New ADODB.Recordset
Dim ccod_almacen    As String
Dim cnum_vale       As String
Dim ctipo_vale      As String * 1
Dim WMONEDA As String * 1

    ccod_almacen = Right(txtalmacen.Text, 2)
    cnum_vale = Trim(txtnumero.Text)
    costo = Trim(txtccosto.Text)
    With acr_vales
        .DataControl1.ConnectionString = cnn_dbbancos
        If Left(txtnumero.Text, 1) = "I" Then
            prov = Trim(txtproveedor.Text)
            ctipo_vale = "I"
            .Lbl_vale.Caption = " VALE DE INGRESO "
            .lblprov.Visible = True
            .lblpunto.Visible = True
            .fldprov.Visible = True
            .lblpie2.Caption = "Entregado por"
        Else
            ctipo_vale = "S"
            .Lbl_vale.Caption = " VALE DE SALIDA "
            .lblprov.Visible = False
            .lblpunto.Visible = False
            .fldprov.Visible = False
            .lblpie2.Caption = "Hecho por"
        End If
        
        WMONEDA = IIf(cmbmoneda.ListIndex = 0, "S", "D")
        csql = "SELECT DISTINCTROW A.F2CODALM, A.F4NUMVAL, A.F1CODORI, D.F1NOMORI, A.F2CODPROV, A.F4NUMDOC, A.F4OBSERVA, A.F4CENTRO, A.F4FECVAL, B.F5CODPRO AS CODIGO, B.F3CANPRO, C.F5NOMPRO, C.F5CODFAB, C.F7CODMED, C.F5CODPRO, B.f3valdol as f5prevta, B.F3CANPRO*B.f3valdol AS PRECIO " & _
                " FROM ((IF4VALES AS A INNER JOIN IF3VALES AS B ON (A.F2CODALM = B.F2CODALM) AND (A.F4NUMVAL = B.F4NUMVAL)) INNER JOIN IF5PLA AS C ON B.F5CODPRO = C.F5CODPRO) INNER JOIN SF1ORIGENES AS D ON A.F1CODORI = D.F1CODORI " & _
                " WHERE (((A.F2CODALM)='" & txtalmacen.Text & "') AND ((A.F4NUMVAL)='" & cnum_vale & "') AND ((A.F1CODORI)='" & txtconcepto.Text & "') AND ((B.F5CODPRO)=[c].[F5CODPRO]) AND ((C.F5CODPRO)=[B].[F5CODPRO])) " & _
                " ORDER BY A.F4NUMVAL, B.F5CODPRO, C.F5CODFAB;"
        .DataControl1.Source = csql
        .fldnomprov.Text = pnlproveedor.Caption
        .fldalmacen.Text = Mid(cmbalmacen.Text, 200)
        .fldnomcosto.Text = pnlccosto.Caption
        .fldempresa.Text = wnomcia
        .fldfecha.Text = Format(Date, "dd/mm/yyyy")
        .fldvale.Text = cnum_vale
        .fldalma.Text = ccod_almacen
        .Show vbModal
    End With

End Sub

Private Sub SUMA_CANT_OCOMPRA(pnumorden As Double, palmacen As String, pnumvale As String)
    
    If rsif3vales.State = adStateOpen Then rsif3vales.Close
    rsif3vales.Open "SELECT * FROM IF3VALES WHERE F4NUMVAL = '" & pnumvale & "' AND F2CODALM = '" & palmacen & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsif3vales.EOF Then
        Do While Not rsif3vales.EOF
            cnn_dbbancos.Execute ("UPDATE IF3ORDEN SET F3CANFAL = F3CANFAL + " & rsif3vales.Fields("F3CANPRO") & " WHERE F4NUMORD=" & pnumorden & " AND F3CODPRO = '" & rsif3vales.Fields("F5CODPRO") & "'") 'rstempo.Fields("CODPROD") & "'")
            rsif3vales.MoveNext
        Loop
    End If
    rsif3vales.Close
    
End Sub

Private Function VALIDA_PROVEEDOR(pproveedor As String)
Dim sw_e    As Boolean

    If rsproveedor.State = adStateOpen Then rsproveedor.Close
    rsproveedor.Open "SELECT F2NOMPROV FROM EF2PROVEEDORES WHERE F2NEWRUC='" & pproveedor & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsproveedor.EOF Then
        wnomprov = Trim(rsproveedor.Fields("F2NOMPROV") & "")
        sw_e = True
    Else
        sw_e = False
    End If
    rsproveedor.Close
    VALIDA_PROVEEDOR = sw_e

End Function

Private Function VALIDA_CONCEPTO_INV(pconcepto As String)
Dim sw_e    As Boolean

    If rsconcepto_inv.State = adStateOpen Then rsconcepto_inv.Close
    rsconcepto_inv.Open "SELECT F1NOMORI,F1PARTIDA FROM SF1ORIGENES WHERE F1CODORI='" & pconcepto & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsconcepto_inv.EOF Then
        wnomconcepto = Trim(rsconcepto_inv.Fields("F1NOMORI") & "")
        wpartida = Trim(rsconcepto_inv.Fields("F1PARTIDA") & "")
        sw_e = True
    Else
        sw_e = False
    End If
    rsconcepto_inv.Close
    VALIDA_CONCEPTO_INV = sw_e

End Function

Private Sub cmbalmacen_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        abofecha.SetFocus
    End If

End Sub

Private Sub cmbconcepto_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        'txttc.SetFocus
    End If

End Sub

Private Sub cmbmarca_KeyPress(KeyAscii As Integer)
If KeyAscii = 13 Then txtserie.SetFocus
End Sub

Private Sub cmbmoneda_keypress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        If txtuupp.Visible = True Then
            txtuupp.SetFocus
        Else
            txtccosto.SetFocus
           ' TxtSerie.SetFocus
        End If
    End If

End Sub

Private Sub cmbalmacen_Click()
    
    txtalmacen.Text = Right(cmbalmacen.Text, 2)
   
End Sub

Private Sub cmbconcepto_Click()
Dim csql        As String
Dim cf1costo    As String

    txtconcepto.Text = Trim(Mid(cmbconcepto.Text, 200))
    csql = "SELECT F1COSTO FROM SF1ORIGENES WHERE F1CODORI='" & txtconcepto.Text & "'"
    If rst.State = adStateOpen Then rst.Close
    rst.Open csql, cnn_dbbancos, adOpenStatic, adLockReadOnly
    If Not rst.EOF Then
        cf1costo = Trim("" & rst.Fields("F1COSTO"))
    End If
    rst.Close
    
    Select Case cf1costo
        Case "*":
            dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Visible = True
            dxDBGrid1.Columns.ColumnByFieldName("IGV").Visible = True
            dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Visible = True
        Case "1":
            dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Visible = True
            dxDBGrid1.Columns.ColumnByFieldName("IGV").Visible = False
            dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Visible = False
        Case Else
            dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Visible = False
            dxDBGrid1.Columns.ColumnByFieldName("IGV").Visible = False
            dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Visible = False
    End Select
           
End Sub

Private Sub cmbtipo_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        If Trim(cmbtipo.Text) <> "" And sw_cabecera = False Then
            sw_cabecera = True
        End If

        txtserfac.SetFocus
    End If

End Sub

Private Sub cmdimporta_Click()

    hlp_importaciones.Show vbModal
    If hlp_importaciones.DataGrid.SelBookmarks.Count > 0 Then
        For X = 0 To hlp_importaciones.DataGrid.SelBookmarks.Count - 1
            hlp_importaciones.DataGrid.Bookmark = hlp_importaciones.DataGrid.SelBookmarks.item(X)
            BuscaImportacion (Trim(hlp_importaciones.DataGrid.Columns(0)))
        Next
    End If
    Unload hlp_importaciones

End Sub

Private Sub cmdoc_Click()

    wrucprov = txtproveedor.Text
    whelpoc = "S"
    hlp_ocompra.Show 1
    whelpoc = "N"
    SELECCIONA_OCOMPRAS
    Unload hlp_ocompra

End Sub

Private Sub dxDBGrid1_OnAfterDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction)
    
    If sw_nuevo_item = False Then
        If Action = daInsert Then
            dxDBGrid1.Dataset.Edit
            dxDBGrid1.Columns.ColumnByFieldName("ITEM").Value = dxDBGrid1.Dataset.RecordCount + 1
        End If
    End If
           
End Sub

Private Sub CONFIGURA_GRID()

    With dxDBGrid1.Options
        .Set (egoEditing)
        .Set (egoTabs)
        .Set (egoTabThrough)
        .Set (egoCanDelete)
        .Set (egoCanAppend)
        .Set (egoCanInsert)
        .Set (egoImmediateEditor)
        .Set (egoShowIndicator)
        .Set (egoCanNavigation)
        .Set (egoHorzThrough)
        .Set (egoVertThrough)
        .Set (egoAutoWidth)
        .Set (egoEnterShowEditor)
        .Set (egoEnterThrough)
        .Set (egoShowButtonAlways)
        
        .Set (egoColumnSizing)
        .Set (egoColumnMoving)
        .Set (egoTabThrough)
        .Set (egoConfirmDelete)
        .Set (egoCanNavigation)
        .Set (egoCancelOnExit)
        .Set (egoLoadAllRecords)
        .Set (egoShowHourGlass)
        .Set (egoUseBookmarks)
        .Set (egoUseLocate)
        .Set (egoAutoCalcPreviewLines)
        .Set (egoBandSizing)
        .Set (egoBandMoving)
        .Set (egoDragScroll)
        '.Set (egoAutoSort)
        .Set (egoExpandOnDblClick)
        .Set (egoShowFooter)
        .Set (egoShowGrid)
        .Set (egoShowButtons)
        .Set (egoNameCaseInsensitive)
        .Set (egoShowHeader)
        .Set (egoShowPreviewGrid)
        .Set (egoShowBorder)
        .Set (egoDynamicLoad)
        '.Set (egoRowSelect)
    End With

    dxDBGrid1.Columns.ColumnByFieldName("ITEM").Visible = False
    dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Visible = False
    dxDBGrid1.Columns.ColumnByFieldName("IGV").SummaryFooterType = cstSum
    dxDBGrid1.Columns.ColumnByFieldName("TOTAL").SummaryFooterType = cstSum
    
End Sub

Private Sub AdicionaItem2()
Dim sw_nuevo_temp   As Boolean
Dim i               As Integer

    dxDBGrid1.Dataset.Active = False
    'If sw_nuevo_documento = False Then
        DELETEREC_N cnomtabla, cnn_form
        dxDBGrid1.Dataset.Refresh
    'End If
    dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
    dxDBGrid1.Dataset.Active = True
    dxDBGrid1.Dataset.Close
    dxDBGrid1.Dataset.Open

    With dxDBGrid1.Dataset
        sw_nuevo_temp = False
        sw_nuevo_item = True
    
        For i = 1 To 1
            'If sw_nuevo_temp = False Then
            If sw_nuevo_documento = False Then
                If sw_nuevo_documento = True Then
                    .Edit
                Else
                    .Append
                End If
                sw_nuevo_temp = True
            Else
                .Append
            End If
            .FieldValues("ITEM") = i
            .FieldValues("CODPROD") = ""
            .FieldValues("CODFAB") = ""
            .FieldValues("marca") = ""
            .FieldValues("DESCRIPCION") = ""
            .FieldValues("UMEDIDA") = ""
            .FieldValues("CANTIDAD") = Format(0, "###,##0.00")
            .FieldValues("COSTOUNI") = Format(0, "###,##0.0000")
            .FieldValues("IGV") = Format(0, "###,##0.00")
            .FieldValues("TOTAL") = Format(0, "###,##0.00")
        Next
        .Post
        sw_nuevo_item = False
    End With
    
    dxDBGrid1.Dataset.Close
    dxDBGrid1.Dataset.Open
    
End Sub

Private Sub AdicionaItem()
Dim sw_nuevo_temp   As Boolean
Dim i               As Integer

    dxDBGrid1.Dataset.Active = False
    If sw_nuevo_documento = False Then
        DELETEREC_N cnomtabla, cnn_form
        dxDBGrid1.Dataset.Refresh
    End If

    dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
    dxDBGrid1.Dataset.Active = True
    dxDBGrid1.Dataset.Close
    dxDBGrid1.Dataset.Open
    
    With dxDBGrid1.Dataset
        sw_nuevo_temp = False
        sw_nuevo_item = True
    
        For i = 1 To 1
            If sw_nuevo_temp = False Then
                If sw_nuevo_documento = True Then
                    .Edit
                Else
                    .Append
                End If
                sw_nuevo_temp = True
            Else
                .Append
            End If
            .FieldValues("ITEM") = i
            .FieldValues("CODPROD") = ""
            .FieldValues("CODFAB") = ""
            .FieldValues("MARCA") = ""
            .FieldValues("DESCRIPCION") = ""
            .FieldValues("UMEDIDA") = ""
            .FieldValues("CANTIDAD") = Format(0, "###,##0.00")
            .FieldValues("TOTAL") = Format(0, "###,##0.00")
            .FieldValues("AFECTO") = ""
        Next
        .Post
        
        sw_nuevo_item = False
        
    End With
    dxDBGrid1.Dataset.Close
    dxDBGrid1.Dataset.Open

End Sub

Private Sub abofecha_GotFocus()

    abofecha.FocusSelect = True

End Sub

Private Sub abofecha_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        cmbconcepto.SetFocus
    End If

End Sub

Private Sub abofecha_LostFocus()

    If IsDate(abofecha.Value) Then
        If rscambios.State = adStateOpen Then rscambios.Close
        rscambios.Open "SELECT * FROM CAMBIOS WHERE CVDATE(FECHA)=CVDATE('" & abofecha.Value & "')", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rscambios.EOF Then
            txttc.Text = Format(Val(rscambios.Fields("CAMBIO") & ""), "0.000")
        Else
            txttc.Text = Format(0, "0.000")
        End If
        rscambios.Close
    Else
        MsgBox "Fecha incorrecta. Verifique.", vbCritical, "Atención"
        abofecha.SetFocus
    End If

End Sub

Private Sub dxDBGrid1_OnBeforeDatasetAction(ByVal Action As DXDBGRIDLibCtl.ExDatasetAction, Allow As Boolean)
    
    If sw_nuevo_item = False Then
        If Action = daInsert Then
            If dxDBGrid1.Dataset.RecordCount > 0 Then
                If Len(Trim(dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value & "")) = 0 Then
                    Allow = False
                Else
                    dxDBGrid1.Columns.FocusedIndex = 0
                End If
            End If
        End If
        If Action = daDelete Then
            sw_detalle = True
            dxDBGrid1.Dataset.Refresh
        End If
    End If

End Sub

Private Sub dxDBGrid1_OnEditButtonClick(ByVal Column As DXDBGRIDLibCtl.IdxGridColumn, ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
Dim cad As String

    If dxDBGrid1.Columns.FocusedColumn.FieldName = "CODFAB" Or dxDBGrid1.Columns.FocusedColumn.FieldName = "CODPROD" Then
        wcod_alm = txtalmacen.Text
        wcodproducto = ""
        sw_ayuda_prod = True
        wmarca = Trim(Mid(cmbmarca.Text, 200))
        cad = ""
        If Not wmarca = "" Then
            cad = " and a.f5marca='" & wmarca & "'"
        End If
        'hlp_productos.cad = cad
        'hlp_productos.Show 1
        ayuda_productos.Show 1
        If Len(Trim(wcodproducto)) > 0 Then
            dxDBGrid1.Dataset.Edit
            dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value = wcodproducto
            dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value = wcodfab
            dxDBGrid1.Columns.ColumnByFieldName("MARCA").Value = wmarca
            dxDBGrid1.Columns.ColumnByFieldName("DESCRIPCION").Value = wdesproducto
            dxDBGrid1.Columns.ColumnByFieldName("UMEDIDA").Value = wmedida
            dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value = wprecos
            dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Value = wafecto
            dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value = 0#
            dxDBGrid1.Dataset.Post
            dxDBGrid1.Columns.FocusedIndex = dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").ColIndex
        End If
    End If

End Sub

Private Sub dxDBGrid1_OnEdited(ByVal Node As DXDBGRIDLibCtl.IdxGridNode)
Dim rst As New ADODB.Recordset
Dim cad     As String
Dim codprod As String
    
If dxDBGrid1.Dataset.State <> 0 And dxDBGrid1.Dataset.State <> 1 Then
    If sw_nuevo_item = False Then
    If dxDBGrid1.Columns.FocusedColumn.FieldName = "CODFAB" Or dxDBGrid1.Columns.FocusedColumn.FieldName = "CODPROD" Then
        wcodproducto = ""
        wcod_alm = txtalmacen.Text
        wcodproducto = "" & dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value
        codprod = "" & dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value
        wmarca = Trim(Mid(cmbmarca.Text, 200))
        cad = ""
        If Not wmarca = "" Then
            cad = " and a.f5marca='" & wmarca & "'"
        End If
        
        SQL = "Select A.f5codpro,A.F5CODFAB,A.F5NOMPRO,A.F5valvta,A.F5PRECOS,C.F7SIGMED,D.F2DESMAR,A.F7CODMED,A.F5AFECTO " & _
              "FROM IF5PLA AS A,EF7MEDIDAS AS C,EF2MARCAS AS D " & _
              "WHERE (A.F5CODFAB='" & wcodproducto & "' or A.F5CODPRO = '" & codprod & "' ) " & _
              "AND A.F7CODMED=C.F7CODMED AND A.F5MARCA=D.F2CODMAR " & cad
        If rsif5pla.State = adStateOpen Then rsif5pla.Close
        rsif5pla.Open SQL, cnn_dbbancos, adOpenStatic, adLockOptimistic
        If Not rsif5pla.EOF Then
            wVariosProductos = False
            gcodpro = wcodproducto
            If Len(Trim(wcodproducto)) > 0 Or Len(Trim(codprod)) > 0 Then
                If rsif5pla.RecordCount > 1 Then      'Existe más de 1 producto con el mismo codigo de fabricante
                    frmdetalle.Caption = "Producto " & gcodpro
                    frmdetalle.grddetalle.Rows = 1
                    wVariosProductos = True
                    wf5codpro = ""
                    Do While Not rsif5pla.EOF
                        frmdetalle.grddetalle.Rows = frmdetalle.grddetalle.Rows + 1
                        frmdetalle.grddetalle.TextMatrix(frmdetalle.grddetalle.Rows - 1, 1) = "" & rsif5pla("f2desmar")
                        frmdetalle.grddetalle.TextMatrix(frmdetalle.grddetalle.Rows - 1, 2) = "" & rsif5pla("f5codpro")
                        frmdetalle.grddetalle.TextMatrix(frmdetalle.grddetalle.Rows - 1, 3) = "" & rsif5pla("f5nompro")
                        rsif5pla.MoveNext
                    Loop
                    rsif5pla.MoveFirst
                    frmdetalle.Show vbModal
                End If
                
                If wVariosProductos Then
                    If Len(Trim(wf5codpro)) > 0 Then
                        cad = "f5codpro='" & wf5codpro & "'"
                        rsif5pla.Find cad
                    Else
                        dxDBGrid1.Dataset.Edit
                        dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("DESCRIPCION").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("UMEDIDA").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("MARCA").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value = 0#
                        dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Value = ""
                        dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value = 0#
                        dxDBGrid1.Dataset.Post
                        wcodproducto = ""
                        dxDBGrid1.Columns.FocusedIndex = dxDBGrid1.Columns.ColumnByFieldName("codfab").ColIndex
                        rsif5pla.Close
                        Exit Sub
                    End If
                End If

                dxDBGrid1.Dataset.Edit
                dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value = "" & rsif5pla.Fields("F5CODPRO")
                dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value = "" & rsif5pla.Fields("F5CODFAB")
                dxDBGrid1.Columns.ColumnByFieldName("DESCRIPCION").Value = "" & rsif5pla.Fields("F5NOMPRO")
                dxDBGrid1.Columns.ColumnByFieldName("UMEDIDA").Value = "" & rsif5pla.Fields("F7SIGMED")
                dxDBGrid1.Columns.ColumnByFieldName("MARCA").Value = "" & rsif5pla.Fields("F2DESMAR")
                wcosto = Val(Costo_Unitario("" & rsif5pla.Fields("F5CODPRO"), abofecha.Value, Left(cmbmoneda.Text, 1)) & "")
                dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value = Format(wcosto, "#,###,##0.00")
                dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Value = "" & rsif5pla.Fields("F5AFECTO")
                dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value = 0#
                sw_nuevo_item = True
                dxDBGrid1.Dataset.Post
                sw_nuevo_item = False
                dxDBGrid1.Columns.FocusedIndex = dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").ColIndex - 1
            End If
        Else
            MsgBox "El Producto No Existe", vbInformation, "Atención"
            dxDBGrid1.Dataset.Edit
            dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("CODFAB").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("DESCRIPCION").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("UMEDIDA").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("MARCA").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value = 0#
            dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Value = ""
            dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value = 0#
            dxDBGrid1.Dataset.Post
            wcodproducto = ""
            dxDBGrid1.Columns.FocusedIndex = 0
        End If
        rsif5pla.Close
    End If
    
    If dxDBGrid1.Columns.FocusedColumn.FieldName = "COSTOUNI" Then
        If Val("" & dxDBGrid1.Columns.ColumnByFieldName("costouni").Value) = 0 Then
            MsgBox "Debe Ingresar el Costo del Producto " & dxDBGrid1.Columns.ColumnByFieldName("descripcion").Value, vbInformation, "Aviso"
            dxDBGrid1.Columns.FocusedIndex = 6
            Exit Sub
        End If
    End If
    
    
        If dxDBGrid1.Columns.FocusedColumn.FieldName = "COSTOUNI" Or dxDBGrid1.Columns.FocusedColumn.FieldName = "CANTIDAD" Then
            dxDBGrid1.Dataset.Edit
            sw_detalle = True
            If dxDBGrid1.Columns.ColumnByFieldName("AFECTO").Value = "*" Then
                dxDBGrid1.Columns.ColumnByFieldName("IGV").Value = Format((Val(Format(dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value, "0.00")) * Val(Format(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value, "0.0000"))) * (wgigv / 100), "###,###,##0.00")
            Else
                dxDBGrid1.Columns.ColumnByFieldName("IGV").Value = Format(0, "0.00")
            End If
            dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Value = Format(Val(Format(dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value, "0.00")) * Val(Format(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value, "0.0000")) + Val(Format(dxDBGrid1.Columns.ColumnByFieldName("IGV").Value, "0.00")), "###,###,##0.00")
            dxDBGrid1.Dataset.Post
        End If
    End If
End If
End Sub

Private Sub dxDBGrid1_OnKeyDown(KeyCode As Integer, ByVal Shift As Long)

    If KeyCode = 115 Then
        If MsgBox("¿Desea Eliminar el Registro Actual?", vbQuestion + vbYesNo, "Sistema de Logística") = vbYes Then
            sw_nuevo_item = True
            If dxDBGrid1.Dataset.RecNo = 1 Then
                dxDBGrid1.Dataset.Delete
                AdicionaItem
            Else
                dxDBGrid1.Dataset.Delete
            End If
            sw_nuevo_item = False
        End If
    ElseIf KeyCode = vbKeyDown Then
        'dxDBGrid1.Columns.FocusedIndex = 0
    
    End If
    
End Sub


Private Sub Form_Activate()
    
    If sw_nuevo_documento = True Then
        If sw_activate = True Then
            sw_activate = False
            cmbmoneda.ListIndex = 0
            'cmbalmacen.ListIndex = 0
            'cmbconcepto.ListIndex = 0
        End If
    End If
    
End Sub

Private Sub Form_Load()
Dim CadSql          As String
Dim pnumvale        As String
Dim palmacen        As String
Dim Ni As Single
Dim Num As Single

    wopcion = 0
    If wf1uupp = "*" Then
        lbluupp.Caption = "UUPP"
        cmbmarca.Visible = False
        txtuupp.Visible = True
        pnluupp.Visible = True
    Else
        lbluupp.Caption = "Marca"
        cmbmarca.Visible = True
        txtuupp.Visible = False
        pnluupp.Visible = False
        CargarMarca
    End If
    sw_nuevo_item = False
    ctipoadm_bd = "" '---- "M" -> mysql
    'Me.Height = 8040
    'Me.Width = 10530
    'Me.Left = 720
    'Me.Top = 645
    Me.Height = 7890
    Me.Width = 11530
    Me.Left = 1500
    Me.Top = 1050
        
    If rs.State = adStateOpen Then rs.Close
    rs.Open "select f2codalm,f2nomalm from ef2almacenes order by f2nomalm asc", cnn_dbbancos, adOpenStatic, adLockReadOnly
    If Not rs.EOF Then
        rs.MoveFirst
        Do While Not rs.EOF
            cmbalmacen.AddItem rs.Fields("f2nomalm") & "" & Space(50) & rs.Fields("F2CODALM") & ""
            rs.MoveNext
        Loop
    End If
    rs.Close
    
    If rst.State = adStateOpen Then rst.Close
    rst.Open "Select * FROM SF1ORIGENES WHERE F1TIPMOV='I' ORDER BY F1CODORI", cnn_dbbancos, adOpenStatic, adLockReadOnly
    If Not rst.EOF Then
        rst.MoveFirst
        Do While Not rst.EOF
            cad = Space(255)
            Mid(cad, 1) = "" & rst.Fields("f1nomori")
            Mid(cad, 200) = "" & rst.Fields("f1codori")
            cmbconcepto.AddItem cad
            rst.MoveNext
        Loop
    End If
    rst.Close
    
    sw_activate = True
    
    cnombase = wusuario & "VALES" & Format(Time, "hh_mm_ss") & ".MDB"
    'cnombase = "ValesTmp.mdb"
    CREATEDATABASE_N wrutatemp & "\", cnombase
    cnomtabla = "DETALLE"
    
    cconex_form = "Provider=Microsoft.Jet.OLEDB.4.0;Data Source=" & wrutatemp & "\" & cnombase & ";Persist Security Info=False"
    cnn_form.Open cconex_form
    
    CadSql = "(ITEM TEXT(4),CODPROD TEXT(15),CODFAB TEXT(20),DESCRIPCION TEXT(100),MARCA TEXT(30), " & _
             "UMEDIDA TEXT(4),CANTIDAD DOUBLE,COSTOUNI DOUBLE,IGV DOUBLE,TOTAL DOUBLE,AFECTO TEXT(1))"
    
    CREATETABLE_N cnomtabla, CadSql, cnn_form
    DELETEREC_N cnomtabla, cnn_form
    
    CONFIGURA_GRID
     
    If rsdocumentos.State = adStateOpen Then rsdocumentos.Close
    rsdocumentos.Open "SELECT * FROM DOCUMENTOS ORDER BY F2CODDOC", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsdocumentos.EOF Then
        rsdocumentos.MoveFirst
        Do While Not rsdocumentos.EOF
            cmbtipo.AddItem rsdocumentos.Fields("F2DESDOC") & "" & Space(50) & rsdocumentos.Fields("F2CODDOC") & ""
            rsdocumentos.MoveNext
        Loop
    End If
    rsdocumentos.Close
         
    sw_detalle = False
    If sw_nuevo_documento = True Then
        nuevo
        AdicionaItem
        sw_cabecera = False
    Else
        sw_cabecera = True
        palmacen = lista_vales.dxDBGrid1.Columns(1).Value
        pnumvale = lista_vales.dxDBGrid1.Columns(2).Value
        BUSCA_VALE palmacen, pnumvale
        sw_cabecera = False
        sw_nuevo_documento = False
        cmbalmacen.Enabled = False
    End If
    
    If sw_nuevo_documento = True Then
        SSActiveToolBars1.Tools("ID_Grabar").Enabled = True
        SSActiveToolBars1.Tools("ID_Nuevo").Enabled = True
        SSActiveToolBars1.Tools("ID_Eliminar").Enabled = False
        SSActiveToolBars1.Tools("ID_Imprimir").Enabled = False
    Else
        SSActiveToolBars1.Tools("ID_Nuevo").Enabled = True
        SSActiveToolBars1.Tools("ID_Eliminar").Enabled = True
        SSActiveToolBars1.Tools("ID_Grabar").Enabled = True
        SSActiveToolBars1.Tools("ID_Imprimir").Enabled = True
    End If
    
    xvale = 1
   
End Sub

Private Sub nuevo()

    txtnumero.Text = ""
    txtalmacen.Text = ""
    abofecha.Value = Format(Date, "DD/MM/YYYY")
    txtconcepto.Text = ""
    txtserie.Text = ""
    txtnumdoc.Text = ""
    txtserfac.Text = ""
    txtnumfac.Text = ""
    
    cmbconcepto.ListIndex = -1
    txtconcepto.Text = Trim(Mid(cmbconcepto.Text, 200))
    
    dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Visible = False
    dxDBGrid1.Columns.ColumnByFieldName("IGV").Visible = False
    dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Visible = False
    
    cmbalmacen.ListIndex = -1
    txtalmacen.Text = Right(cmbalmacen.Text, 2)
            
    txttc.Text = "0.000"
    txtproveedor.Text = "": pnlproveedor.Caption = ""
    txtccosto.Text = "": pnlccosto.Caption = ""
    txtobserva.Text = ""
    txtuupp.Text = "": pnluupp.Caption = ""
            
    'tc
    If IsDate(abofecha.Value) Then
        If rscambios.State = adStateOpen Then rscambios.Close
        rscambios.Open "SELECT * FROM CAMBIOS WHERE CVDATE(FECHA)=CVDATE('" & abofecha.Value & "')", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rscambios.EOF Then
            txttc.Text = Format(Val(rscambios.Fields("CAMBIO") & ""), "0.000")
        Else
            txttc.Text = Format(0, "0.000")
        End If
        rscambios.Close
    End If
    ''''''''
End Sub

Private Sub Form_Unload(Cancel As Integer)
        
    cnn_form.Close
    
    sw_nuevo_item = True
    dxDBGrid1.Dataset.Close
    ELIMINA_BD_N wrutatemp, cnombase
    
    If sw_ayuda_prod = True Then
        Unload hlp_productos
    End If
    
    If sw_importa_valedeingreso = False Then
        lista_vales.dxDBGrid1.Dataset.Active = False
        lista_vales.dxDBGrid1.Dataset.Refresh
        lista_vales.dxDBGrid1.Dataset.Active = True
    End If
    
End Sub

Private Sub SSActiveToolBars1_ToolClick(ByVal Tool As ActiveToolBars.SSTool)
Dim rst As ADODB.Recordset
    
    Select Case Tool.Id
        Case "ID_Nuevo"
            Me.MousePointer = 11
            sw_nuevo_documento = False
            sw_detalle = False
            nuevo
            AdicionaItem
            AdicionaItem
            sw_nuevo_documento = True
            Me.MousePointer = 1
            cmbalmacen.Enabled = True
            SSActiveToolBars1.Tools("ID_Eliminar").Enabled = False
            SSActiveToolBars1.Tools("ID_Imprimir").Enabled = False
            
        Case "ID_Grabar"
            If dxDBGrid1.Dataset.State = dsEdit Or dxDBGrid1.Dataset.State = dsInsert Then
                dxDBGrid1.Dataset.Post
                sw_detalle = True
            End If
            If sw_cabecera = True Or sw_detalle = True Then
                '-----------------------------------------------
                If cmbalmacen.ListIndex < 0 Then
                    MsgBox "Debe seleccionar el almacén.", vbDefaultButton1 + vbInformation, "Atención"
                    cmbalmacen.SetFocus
                    Exit Sub
                End If
                '-----------------------------------------------
                If cmbconcepto.ListIndex < 0 Then
                    MsgBox "Debe seleccionar el concepto de ingreso.", vbDefaultButton1 + vbInformation, "Atención"
                    cmbconcepto.SetFocus
                    Exit Sub
                End If
                '-----------------------------------------------
                If Val(txttc.Text & "") = 0 Then
                    'MsgBox "Ingrese el tipo de cambio ", vbDefaultButton1 + vbInformation, "Atención"
                    'If txttc.Enabled = True Then
                    '    txttc.SetFocus
                    'Else
                    '    txttc.Enabled = True
                    '    txttc.SetFocus
                    'End If
                    'Exit Sub
                    txttc.Text = "3.45"
                End If
                '-----------------------------------------------
                Set rst = New ADODB.Recordset
                'Valida Existencias de Productos que ingresan a Almacén
                cnn_form.Execute "update " & cnomtabla & " set cantidad = cantidad"
                If rst.State = adStateOpen Then rst.Close
                SQL = "SELECT sum(cantidad) as cant FROM " & cnomtabla
                rst.Open SQL, cnn_form, adOpenStatic, adLockOptimistic
                If Not rst.EOF Then
                    xcant = Val("" & rst("cant"))
                    If xcant = 0 Then
                        Me.MousePointer = vbDefault
                        MsgBox "Debe Ingresar Cantidad del Producto(s)", vbInformation, "Sistema de Logística"
                        rst.Close
                        Exit Sub
                    End If
                End If
                rst.Close
                '-----------------------------------------------
                Me.MousePointer = vbHourglass
                grabar
                sw_detalle = False
                sw_cabecera = False
            End If
            Me.MousePointer = 1
            SSActiveToolBars1.Tools("ID_Imprimir").Enabled = True
            SSActiveToolBars1.Tools("ID_Nuevo").Enabled = True
            SSActiveToolBars1.Tools("ID_Eliminar").Enabled = True
            
        Case "ID_Eliminar":
            Me.MousePointer = 11
            elimina txtnumero.Text, txtalmacen.Text
            
            sw_nuevo_documento = True
            nuevo
            dxDBGrid1.Dataset.Close
            DELETEREC_N cnomtabla, cnn_form
            AdicionaItem
            
            Me.MousePointer = 1
        Case "ID_Imprimir":
            IMPRIMIR_VALES
        Case "ID_CargarData":
            frmExcel.Show 1
        Case "ID_Lista":
            If dxDBGrid1.Dataset.State = dsEdit Or dxDBGrid1.Dataset.State = dsInsert Then
                dxDBGrid1.Dataset.Post
                sw_detalle = True
            End If
            If sw_cabecera = True Or sw_detalle = True Then
                If MsgBox("El Vale de Ingreso no ha sido grabado ... Desea Grabar ?", vbQuestion + vbYesNo, "Atenciòn") = vbYes Then
                    grabar
                    sw_detalle = False
                End If
            End If
            Unload Me
    End Select

End Sub

Private Sub grabar()
On Error GoTo HndError
Dim calma_obra      As String
    
    'If rsccosto.State = adStateOpen Then rsccosto.Close
    'rsccosto.Open "SELECT F3ALMACEN FROM CENTROS WHERE F3COSTO='" & txtccosto.Text & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    'If Not rsccosto.EOF Then
    '    calma_obra = Trim("" & rsccosto.Fields("F3ALMACEN"))
    'End If
    'rsccosto.Close
    
    cnn_dbbancos.BeginTrans
    
    GRABA_ING_ALMACEN_CENTRAL
    
    'If Trim(wtiposalida) = "*" Then  '----- LA EMPRESA ES CONSTRUCTORA (AIC)
    '    If Len(Trim(calma_obra)) > 0 Then
    '        GRABA_SALIDA_X_TRANSF
    '        GRABA_ING_ALMACEN_OBRA calma_obra
    '    Else
    '        GRABA_VALE_SALIDA
    '    End If
    'End If
    
    sw_nuevo_documento = False
    cnn_dbbancos.CommitTrans
    MsgBox "Se ha Actualizado el Vale de Ingreso " & txtnumero.Text, vbInformation, "Sistema de Logística"
    Exit Sub

HndError:
    cnn_dbbancos.RollbackTrans
    Me.MousePointer = vbDefault
    MsgBox "Ha Ocurrido el siguiente error:" & Chr(13) & Chr(13) & Err.Description & "." & Chr(13) & "La Operación de Actualización no se Realizó. Consulte al Proveedor.", vbCritical, "Sistema de Ventas"
    Exit Sub
    
End Sub

Private Sub txtalmacen_Change()
    
    If Trim(txtalmacen.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If
    
End Sub

Private Sub txtalmacen_GotFocus()

    txtalmacen.SelStart = 0: txtalmacen.SelLength = Len(txtalmacen.Text)

End Sub

Private Sub txtalmacen_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        If Len(Trim(txtalmacen.Text)) > 0 Then
            abofecha.SetFocus
        Else
            txtalmacen.SetFocus
        End If
    End If
    
End Sub

Private Sub txtccosto_Change()

    If Trim(txtccosto.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txtccosto_DblClick()

    txtccosto_KeyDown 113, 0
    
End Sub

Private Sub txtccosto_GotFocus()
    
    txtccosto.SelStart = 0: txtccosto.SelLength = Len(txtccosto.Text)
    
End Sub

Private Sub txtccosto_KeyDown(KeyCode As Integer, Shift As Integer)

    If KeyCode = 113 Then
        sw_ayuda = True
        wcodcosto = "": wdescosto = ""
        hlp_centros.Show 1
        sw_ayuda = False
        If Len(Trim(wcodcosto)) > 0 Then
            txtccosto.Text = wcodcosto
            pnlccosto.Caption = wdescosto
            txtccosto_KeyPress 13
        End If
    End If

End Sub

Private Sub txtccosto_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        'CmbMoneda.SetFocus
        cmbmarca.SetFocus
    End If

End Sub

Private Sub txtccosto_LostFocus()
    
    If sw_ayuda = False Then
        'If Val(txttc.Text & "") > 0# Then
            If Len(Trim(txtccosto.Text)) > 0 Then
                If rsccosto.State = adStateOpen Then rsccosto.Close
                rsccosto.Open "SELECT F3DESCRIP FROM CENTROS WHERE F3COSTO='" & txtccosto.Text & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
                If Not rsccosto.EOF Then
                    pnlccosto.Caption = Trim("" & rsccosto.Fields("F3DESCRIP"))
                Else
                    MsgBox "Código de centro de costo no existe. Verifique.", vbCritical, "Atención"
                    txtccosto.SetFocus
                End If
                rsccosto.Close
            Else
                'MsgBox "Falta ingresar el centro de costo.", vbCritical, "Atención"
                'txtccosto.SetFocus
            End If
        'End If
    End If

End Sub

Private Sub txtconcepto_Change()
    
    If Trim(txtconcepto.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txtconcepto_GotFocus()

    txtconcepto.SelStart = 0: txtconcepto.SelLength = Len(txtconcepto.Text)
    
End Sub

Private Sub txtconcepto_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
       ' txttc.SetFocus
    End If

End Sub

Private Sub txtnumdoc_Change()

    If Trim(txtnumdoc.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub TxtNumDoc_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        cmbtipo.SetFocus
    End If

End Sub

Private Sub TxtNumDoc_LostFocus()
    
    txtnumdoc.Text = Format(txtnumdoc.Text, "0000000")
    
End Sub

Private Sub TxtNumFac_Change()

    If Trim(txtnumfac.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub Txtnumfac_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        txtobserva.SetFocus
    End If

End Sub

Private Sub TxtNumFac_LostFocus()
    
    txtnumfac.Text = Format(txtnumfac.Text, "0000000")
    
End Sub

Private Sub txtobserva_Change()

    If Trim(txtobserva.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txtobserva_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        dxDBGrid1.SetFocus
    End If
    
End Sub

Private Sub txtproveedor_Change()

    If Trim(txtproveedor.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txtproveedor_DblClick()

    txtproveedor_KeyDown 113, 0
    
End Sub

Private Sub txtproveedor_GotFocus()

    txtproveedor.SelStart = 0: txtproveedor.SelLength = Len(txtproveedor.Text)
    
End Sub

Private Sub txtproveedor_KeyDown(KeyCode As Integer, Shift As Integer)

    If KeyCode = 113 Then
        sw_ayuda = True
        wcodprov = "": wrucprov = "": wnomprov = ""
        'hlp_proveedores.Show 1
        ayuda_proveedores.Show 1
        sw_ayuda = False
        If Len(Trim(wrucprov)) > 0 Then
            txtproveedor.Text = wrucprov
            pnlproveedor.Caption = wnomprov
            txtproveedor_KeyPress 13
        End If
    End If

End Sub

Private Sub txtproveedor_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        'cmdoc.SetFocus
        cmbmoneda.SetFocus
    End If

End Sub

Private Sub txtproveedor_LostFocus()

    If sw_ayuda = False Then
        'If Val(txttc.Text & "") > 0# Then
            If Len(Trim(txtproveedor.Text)) > 0 Then
                If VALIDA_PROVEEDOR(txtproveedor.Text) = True Then
                    pnlproveedor.Caption = wnomprov
                Else
                    MsgBox "El proveedor no existe. Verifique.", vbCritical, "Atención"
                    txtproveedor.SetFocus
                End If
            End If
        'End If
    End If

End Sub

Private Sub Txtserfac_Change()

    If Trim(txtserfac.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub Txtserfac_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        txtnumfac.SetFocus
    End If

End Sub

Private Sub txtserfac_LostFocus()
    
    txtserfac.Text = Format(txtserfac.Text, "000")
    
End Sub

Private Sub txtserie_Change()

    If Trim(txtserie.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txtserie_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        txtnumdoc.SetFocus
    End If

End Sub

Private Sub TxtSerie_LostFocus()
    
    txtserie.Text = Format(txtserie.Text, "000")
    
End Sub

Private Sub txttc_Change()
    
    If Trim(txttc.Text) <> "" And sw_cabecera = False Then
        sw_cabecera = True
    End If

End Sub

Private Sub txttc_GotFocus()

    txttc.SelStart = 0: txttc.SelLength = Len(txttc.Text)
    
End Sub

Private Sub txttc_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        If txtproveedor.Visible = True Then
            txtproveedor.SetFocus
        Else
            txtccosto.SetFocus
        End If
    Else
        If Not (KeyAscii >= 48 And KeyAscii <= 57 Or KeyAscii = 8 Or Chr(KeyAscii) = ".") Then
            KeyAscii = 0
        End If
    End If

End Sub

Private Sub txttc_LostFocus()

    txttc.Text = Format(txttc.Text, "0.000")
    If Len(Trim(txtconcepto.Text)) > 0 Then
        If Val(Format(txttc.Text, "0.000")) > 0 Then
        Else
            MsgBox "El tipo de cambio no puede ser cero. Verifique.", vbInformation, ""
            txttc.SetFocus
        End If
    End If

End Sub

Private Function GENERA_NUMVALE(palmacen As String, pmes As String, ptipo As String)
Dim cnumvale    As String

    If rsalmacen.State = adStateOpen Then rsalmacen.Close
    rsalmacen.Open "SELECT * FROM EF2ALMACENES WHERE F2CODALM='" & palmacen & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsalmacen.EOF Then
        If ptipo = "I" Then
            cnumvale = Mid(rsalmacen.Fields("F1VALING" & pmes) & "", 1, 4) & Format(Val(Mid(rsalmacen.Fields("F1VALING" & pmes) & "", 5, 4)) + 1, "0000")
        Else
            cnumvale = Mid(rsalmacen.Fields("F1VALSAL" & pmes) & "", 1, 4) & Format(Val(Mid(rsalmacen.Fields("F1VALSAL" & pmes) & "", 5, 4)) + 1, "0000")
        End If
    End If
    rsalmacen.Close
    
    GENERA_NUMVALE = cnumvale
    
End Function

Private Sub SELECCIONA_OCOMPRAS()
Dim X       As Integer

    If hlp_ocompra.Grid1.SelBookmarks.Count > 0 Then
        For X = 0 To hlp_ocompra.Grid1.SelBookmarks.Count - 1
            hlp_ocompra.Grid1.Bookmark = hlp_ocompra.Grid1.SelBookmarks.item(X)
            BUSCA_OCOMPRA Trim(hlp_ocompra.Grid1.Columns(0))
        Next
    End If

End Sub

Private Sub BUSCA_OCOMPRA(pocompra As String)
Dim i                   As Integer
Dim sw_nuevo_temp       As Boolean

    sw_nuevo_temp = False
    If rsif4orden.State = adStateOpen Then rsif4orden.Close
    rsif4orden.Open "SELECT * FROM IF4ORDEN WHERE F4NUMORD = " & Val(pocompra) & "", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsif4orden.EOF Then
        '--------------------- C. COSTO
        txtccosto.Text = Trim("" & rsif4orden.Fields("F4CENTRO"))
        If rsccosto.State = adStateOpen Then rsccosto.Close
        rsccosto.Open "SELECT F3DESCRIP FROM CENTROS WHERE F3COSTO='" & txtccosto.Text & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rsccosto.EOF Then
            pnlccosto.Caption = Trim("" & rsccosto.Fields("F3DESCRIP"))
        End If
        rsccosto.Close
        '-----------------------------------------------------
        If Trim("" & rsif4orden.Fields("F4TIPMON")) = "S" Then
            cmbmoneda.ListIndex = 0
        ElseIf Trim("" & rsif4orden.Fields("F4TIPMON")) = "D" Then
            cmbmoneda.ListIndex = 1
        End If
        
        txtuupp.Text = rsif4orden.Fields("F4UUPP") & ""
        If VALIDA_UUPP(txtuupp.Text) = True Then
            pnluupp.Caption = wdeslocalidad
        End If
        
        If rsif3orden.State = adStateOpen Then rsif3orden.Close
        rsif3orden.Open "SELECT * FROM IF3ORDEN WHERE F4NUMORD = " & Val(pocompra) & " AND F3CANFAL > 0 ", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rsif3orden.EOF Then
            dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
            dxDBGrid1.Dataset.Active = True
        
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
                        
            dxDBGrid1.OptionEnabled = False
            dxDBGrid1.Dataset.DisableControls
            With dxDBGrid1.Dataset
                i = 1
                sw_nuevo_item = True
                rsif3orden.MoveFirst
                Do While Not rsif3orden.EOF
                    If sw_nuevo_temp = False Then
                        sw_nuevo_temp = True
                        .Edit
                    Else
                        .Append
                    End If
                    .FieldValues("ITEM") = i
                    .FieldValues("CODPROD") = Trim("" & rsif3orden.Fields("F3CODPRO"))
                    .FieldValues("CODFAB") = Trim("" & rsif3orden.Fields("F3CODFAB"))
                    
                    If rsif5pla.State = adStateOpen Then rsif5pla.Close
                    rsif5pla.Open "SELECT F5NOMPRO,F7CODMED,F5MARCA,F5CODFAB FROM IF5PLA WHERE F5CODPRO = '" & Trim("" & rsif3orden.Fields("F3CODPRO")) & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
                    If Not rsif5pla.EOF Then
                        .FieldValues("DESCRIPCION") = "" & rsif5pla.Fields("F5NOMPRO")
                        .FieldValues("UMEDIDA") = "" & rsif5pla.Fields("F7CODMED")
                        .FieldValues("marca") = "" & rsif5pla.Fields("f5marca")
                        .FieldValues("CODFAB") = "" & rsif5pla.Fields("F5CODFAB")
                    End If
                    rsif5pla.Close
                    .FieldValues("CANTIDAD") = Format(Val("" & rsif3orden.Fields("F3CANFAL")), "###,##0.00")
                    .FieldValues("COSTOUNI") = Format(Val("" & rsif3orden.Fields("F3PRECOS")), "###,##0.0000")
                    .FieldValues("IGV") = Format(Val("" & rsif3orden.Fields("F3IGV")), "###,##0.00")
                    .FieldValues("TOTAL") = Format(Val("" & rsif3orden.Fields("F3TOTAL")), "###,##0.00")
                    rsif3orden.MoveNext
                    i = i + 1
                Loop
                .Post
                sw_nuevo_item = False
            End With
            dxDBGrid1.Dataset.EnableControls
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
            dxDBGrid1.OptionEnabled = True
        End If
        rsif3orden.Close
    End If
    rsif4orden.Close
End Sub

Private Sub GRABA_ING_ALMACEN_CENTRAL()
Dim cnumvale        As String
Dim ccampo          As String
Dim nitems          As Integer
Dim cdocum$
Dim cmarca_costo    As String

    If sw_nuevo_documento = True Then
        cnumvale = GENERA_NUMVALE(txtalmacen.Text, Format(Month(abofecha.Value), "00"), "I")
        txtnumero.Text = cnumvale
        ctipo = "A"
    Else
        cnumvale = txtnumero.Text
        ctipo = "M"
    End If
    
    '-------------------------------------------------------
    '------------------------- ASIGNA DATOS DE LA CABECERA
    amovs_cab(0).campo = "F4NUMVAL": amovs_cab(0).valor = txtnumero.Text: amovs_cab(0).TIPO = "T"
    amovs_cab(1).campo = "F2CODALM": amovs_cab(1).valor = txtalmacen.Text: amovs_cab(1).TIPO = "T"
    amovs_cab(2).campo = "F4FECVAL": amovs_cab(2).valor = abofecha.Value: amovs_cab(2).TIPO = "F"
    amovs_cab(3).campo = "F1CODORI": amovs_cab(3).valor = txtconcepto.Text: amovs_cab(3).TIPO = "T"
    amovs_cab(4).campo = "F4TIPCAM": amovs_cab(4).valor = txttc.Text: amovs_cab(4).TIPO = "N"
    amovs_cab(5).campo = "F2CODPROV": amovs_cab(5).valor = txtproveedor: amovs_cab(5).TIPO = "T"
    amovs_cab(6).campo = "F4CENTRO": amovs_cab(6).valor = txtccosto.Text: amovs_cab(6).TIPO = "T"
    amovs_cab(7).campo = "F4MONEDA": amovs_cab(7).valor = IIf(cmbmoneda.Text = "Soles", "S", "D"): amovs_cab(7).TIPO = "T"
    amovs_cab(8).campo = "F4SERGUIA": amovs_cab(8).valor = txtserie.Text: amovs_cab(8).TIPO = "T"
    amovs_cab(9).campo = "F4NUMGUIA": amovs_cab(9).valor = txtnumdoc.Text: amovs_cab(9).TIPO = "T"
    amovs_cab(10).campo = "F4TIPDOC": amovs_cab(10).valor = Right(cmbtipo.Text, 2): amovs_cab(10).TIPO = "T"
    amovs_cab(11).campo = "F4SERDOC": amovs_cab(11).valor = txtserfac.Text: amovs_cab(11).TIPO = "T"
    If sw_importa_valedeingreso = True Then
        cdocum$ = Importaciones.txtnumero.Text
    Else
        cdocum$ = txtnumfac.Text
    End If
    amovs_cab(12).campo = "F4NUMDOC": amovs_cab(12).valor = cdocum$: amovs_cab(12).TIPO = "T"
    If ctipo = "A" Then
        amovs_cab(13).campo = "F4FECGRA": amovs_cab(13).valor = Format(Date, "dd/mm/yyyy"): amovs_cab(13).TIPO = "F"
        amovs_cab(14).campo = "F4USEGRA": amovs_cab(14).valor = wusuario: amovs_cab(14).TIPO = "T"
    Else
        amovs_cab(13).campo = "F4FECMOD": amovs_cab(13).valor = Format(Date, "dd/mm/yyyy"): amovs_cab(13).TIPO = "F"
        amovs_cab(14).campo = "F4USEMOD": amovs_cab(14).valor = wusuario: amovs_cab(14).TIPO = "T"
    End If
    amovs_cab(15).campo = "F4OBSERVA": amovs_cab(15).valor = txtobserva.Text: amovs_cab(15).TIPO = "T"
    '----------- OJO  REVISAR ESTO
    amovs_cab(16).campo = "F4NUMORD": amovs_cab(16).valor = 0: amovs_cab(16).TIPO = "N"
    '------------------------------
    amovs_cab(17).campo = "F4UUPP": amovs_cab(17).valor = txtuupp.Text: amovs_cab(17).TIPO = "T"
    '-------------------------------------------------------
    '------------------------- ASIGNA DATOS DEL DETALLE
    amovs_det(0).campo = "F4NUMVAL": amovs_det(0).valor = "": amovs_det(0).TIPO = "T"
    amovs_det(1).campo = "F5CODPRO": amovs_det(1).valor = "": amovs_det(1).TIPO = "T"
    amovs_det(2).campo = "F3CANPRO": amovs_det(2).valor = "": amovs_det(2).TIPO = "N"
    amovs_det(3).campo = "F3VALVTA": amovs_det(3).valor = "": amovs_det(3).TIPO = "N"
    amovs_det(4).campo = "F3IGV": amovs_det(4).valor = "": amovs_det(4).TIPO = "N"
    amovs_det(5).campo = "F3TOTITE": amovs_det(5).valor = "": amovs_det(5).TIPO = "N"
    amovs_det(6).campo = "F2CODALM": amovs_det(6).valor = "": amovs_det(6).TIPO = "T"
    amovs_det(7).campo = "F4FECVAL": amovs_det(7).valor = "": amovs_det(7).TIPO = "F"
    amovs_det(8).campo = "F3VALDOL": amovs_det(8).valor = "": amovs_det(8).TIPO = "N"
    amovs_det(9).campo = "F3IGVDOL": amovs_det(9).valor = "": amovs_det(9).TIPO = "N"
    amovs_det(10).campo = "F3TOTDOL": amovs_det(10).valor = "": amovs_det(10).TIPO = "N"
    amovs_det(11).campo = "": amovs_det(11).valor = "": amovs_det(11).TIPO = "T"
    amovs_det(12).campo = "F3JCG": amovs_det(12).valor = "": amovs_det(12).TIPO = "T"
    
    '------------------- CALCULA NUMERO DE FILAS
    nitems = 0
    If RSDETALLE.State = adStateOpen Then RSDETALLE.Close
    RSDETALLE.Open "SELECT COUNT(ITEM) AS NITEM FROM " & cnomtabla & " WHERE LEN(TRIM(CODPROD)) > 0 OR NOT ISNULL(CODPROD)", cnn_form
    If Not RSDETALLE.EOF Then
        nitems = Val("" & RSDETALLE.Fields("NITEM"))
    End If
    RSDETALLE.Close
    '---------------------------------------------
    cmarca_costo = ""
    If rst.State = adStateOpen Then rst.Close
    rst.Open "Select F1COSTO FROM SF1ORIGENES WHERE F1CODORI='" & txtconcepto.Text & "'", cnn_dbbancos, adOpenStatic, adLockReadOnly
    If Not rst.EOF Then
        cmarca_costo = "" & rst.Fields("F1COSTO")
    End If
    rst.Close
    '---------------------------------------------
    
    ReDim Values(12, nitems)
    
    If RSDETALLE.State = adStateOpen Then RSDETALLE.Close
    RSDETALLE.Open "SELECT * FROM " & cnomtabla & "", cnn_form
    If Not RSDETALLE.EOF Then
        nfil = 0
        RSDETALLE.MoveFirst
        Do While Not RSDETALLE.EOF
            dxDBGrid1.Dataset.RecNo = nfil + 1
            If Len(dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value & "") > 0 Then
                Values(0, nfil) = txtnumero.Text
                Values(1, nfil) = dxDBGrid1.Columns.ColumnByFieldName("CODPROD").Value & ""
                Values(2, nfil) = dxDBGrid1.Columns.ColumnByFieldName("CANTIDAD").Value & ""
                If cmbmoneda.ListIndex = 0 Then
                    Values(3, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value & "") 'RSDETALLE.Fields("COSTOUNI") & "")
                    Values(4, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("IGV").Value & "")
                    Values(5, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Value & "")
                    Values(8, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value & "") / Val(Format(txttc.Text, "0.00"))
                    Values(9, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("IGV").Value & "") / Val(Format(txttc.Text, "0.00"))
                    Values(10, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Value & "") / Val(Format(txttc.Text, "0.00"))
                Else
                    Values(3, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value & "") * Val(Format(txttc.Text, "0.00"))
                    Values(4, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("IGV").Value & "") * Val(Format(txttc.Text, "0.00"))
                    Values(5, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Value & "") * Val(Format(txttc.Text, "0.00"))
                    Values(8, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("COSTOUNI").Value & "")
                    Values(9, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("IGV").Value & "")
                    Values(10, nfil) = Val(dxDBGrid1.Columns.ColumnByFieldName("TOTAL").Value & "")
                End If
                    
                Values(6, nfil) = txtalmacen.Text
                Values(7, nfil) = Format(abofecha.Value, "dd/mm/yyyy")
                Values(11, nfil) = "I"
                
                Values(12, nfil) = cmarca_costo
                
                nfil = nfil + 1
            End If
            RSDETALLE.MoveNext
        Loop
   
    End If
    RSDETALLE.Close
    
    cvalores = "1111111111101"
    
    '-------------------------------------------------------
    '-------------------------------------------------------
    cmes = Format(Month(abofecha.Value), "00")
    If ctipo = "A" Then     '--- Nuevo
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 17, cnn_dbbancos, ""
        
        If sw_graba_registro = True Then
            '------- GRABA DETALLE
            GRABA_REGISTRO_DET amovs_det(), "IF3VALES", ctipo, 12, cnn_dbbancos, "", Values(), nfil - 1, cvalores, cmes, "A"
        End If
        ccampo = "F1VALING" & cmes
        ACTUALIZA_ALMA_VALE cnumvale, ccampo, txtalmacen.Text
    Else    '--- Modificación
        
        '-------------------------------------------------------
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 17, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM='" & txtalmacen.Text & "'"
        '-------------------------------------------------------
        '------- GRABA DETALLE
        cnn_dbbancos.Execute ("DELETE * FROM IF3VALES WHERE F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'")
        GRABA_REGISTRO_DET amovs_det(), "IF3VALES", "A", 12, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'", Values(), nfil - 1, cvalores, cmes, "A"
        '-------------------------------------------------------
    End If
    '-------------------------------------------------------
    
    '''graba envio
    If wIndEnvia = "*" Then 'cnn_dbEnvia
        SQL = "delete from if4vales where f2codalm='" & txtalmacen.Text & "' and f4numval='" & cnumvale & "'"
        cnn_dbEnvia.Execute SQL
        
        GRABA_REGISTRO amovs_cab(), "IF4VALES", "A", 17, cnn_dbEnvia, ""
        If sw_graba_registro = True Then
            '------- GRABA DETALLE
            GRABA_REGISTRO_DET amovs_det(), "IF3VALES", "A", 12, cnn_dbEnvia, "", Values(), nfil - 1, cvalores, cmes, ""
        End If
    End If
    ''''''''''''''
    
End Sub

Private Sub GRABA_SALIDA_X_TRANSF()
Dim cnumvale        As String
Dim ccampo          As String
Dim i               As Integer

    If sw_nuevo_documento = True Then
        cnumvale = GENERA_NUMVALE(txtalmacen.Text, Format(Month(abofecha.Value), "00"), "S")
        txtnumero.Text = cnumvale
        ctipo = "A"
    Else
        cnumvale = txtnumero.Text
        ctipo = "M"
    End If
    
    amovs_cab(0).campo = "F4NUMVAL": amovs_cab(0).valor = cnumvale: amovs_cab(0).TIPO = "T"
    amovs_cab(3).campo = "F1CODORI": amovs_cab(3).valor = wconc_salxtransf: amovs_cab(3).TIPO = "T"
    For i = 0 To nfil - 1
        Values(0, i) = cnumvale
        Values(11, i) = "S"
    Next i
    
    '-------------------------------------------------------
    '-------------------------------------------------------
    cmes = Format(Month(abofecha.Value), "00")
    If ctipo = "A" Then     '--- Nuevo
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, ""
        
        If sw_graba_registro = True Then
            '------- GRABA DETALLE
            GRABA_REGISTRO_DET amovs_det(), "IF3VALES", ctipo, 11, cnn_dbbancos, "", Values(), nfil - 1, cvalores, cmes, "A"
        End If
        
        ccampo = "F1VALSAL" & cmes
        ACTUALIZA_ALMA_VALE cnumvale, ccampo, txtalmacen.Text
        
    Else    '--- Modificación
        
        '-------------------------------------------------------
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'"
        '-------------------------------------------------------
        '------- GRABA DETALLE
        cnn_dbbancos.Execute ("DELETE * FROM IF3VALES WHERE F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'")
        GRABA_REGISTRO_DET amovs_det(), "IF3VALES", "A", 11, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'", Values(), nfil - 1, cvalores, cmes, "A"
    End If
    '-------------------------------------------------------
    '-------------------------------------------------------

End Sub

Private Sub GRABA_ING_ALMACEN_OBRA(palmacen As String)
Dim cnumvale        As String
Dim ccampo          As String
Dim i               As Integer

    If sw_nuevo_documento = True Then
        cnumvale = GENERA_NUMVALE(palmacen, Format(Month(abofecha.Value), "00"), "I")
        txtnumero.Text = cnumvale
        ctipo = "A"
    Else
        cnumvale = txtnumero.Text
        ctipo = "M"
    End If
    
    amovs_cab(0).campo = "F4NUMVAL": amovs_cab(0).valor = cnumvale: amovs_cab(0).TIPO = "T"
    amovs_cab(1).campo = "F2CODALM": amovs_cab(1).valor = palmacen: amovs_cab(1).TIPO = "T"
    amovs_cab(3).campo = "F1CODORI": amovs_cab(3).valor = wconc_ing_obra: amovs_cab(3).TIPO = "T"

    For i = 0 To nfil - 1
        Values(0, i) = cnumvale
        Values(6, i) = palmacen
        Values(11, i) = "I"
    Next i

    '-------------------------------------------------------
    '-------------------------------------------------------
    cmes = Format(Month(abofecha.Value), "00")
    If ctipo = "A" Then     '--- Nuevo
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, ""
        
        If sw_graba_registro = True Then
            '------- GRABA DETALLE
            GRABA_REGISTRO_DET amovs_det(), "IF3VALES", ctipo, 11, cnn_dbbancos, "", Values(), nfil - 1, cvalores, cmes, "A"
        End If
        ccampo = "F1VALING" & cmes
        ACTUALIZA_ALMA_VALE cnumvale, ccampo, palmacen
        
    Else    '--- Modificación
        
        '-------------------------------------------------------
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & palmacen & "'"
        '-------------------------------------------------------
        '------- GRABA DETALLE
        cnn_dbbancos.Execute ("DELETE * FROM IF3VALES WHERE F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & palmacen & "'")
        GRABA_REGISTRO_DET amovs_det(), "IF3VALES", "A", 11, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & palmacen & "'", Values(), nfil - 1, cvalores, cmes, "A"
    End If
    '-------------------------------------------------------

End Sub

Private Sub GRABA_VALE_SALIDA()
Dim cnumvale        As String
Dim ccampo          As String
Dim i               As Integer

    If sw_nuevo_documento = True Then
        cnumvale = GENERA_NUMVALE(txtalmacen.Text, Format(Month(abofecha.Value), "00"), "S")
        txtnumero.Text = cnumvale
        ctipo = "A"
    Else
        cnumvale = txtnumero.Text
        ctipo = "M"
    End If
    
    amovs_cab(0).campo = "F4NUMVAL": amovs_cab(0).valor = cnumvale: amovs_cab(0).TIPO = "T"
    amovs_cab(3).campo = "F1CODORI": amovs_cab(3).valor = wconc_salida: amovs_cab(3).TIPO = "T"
    For i = 0 To nfil - 1
        Values(0, i) = cnumvale
        Values(11, i) = "S"
    Next i
    
    '-------------------------------------------------------
    cmes = Format(Month(abofecha.Value), "00")
    If ctipo = "A" Then     '--- Nuevo
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, ""
        
        If sw_graba_registro = True Then
            '------- GRABA DETALLE
            GRABA_REGISTRO_DET amovs_det(), "IF3VALES", ctipo, 11, cnn_dbbancos, "", Values(), nfil - 1, cvalores, cmes, "A"
        End If
        
        ccampo = "F1VALSAL" & cmes
        ACTUALIZA_ALMA_VALE cnumvale, ccampo, txtalmacen.Text
        
    Else    '--- Modificación
        '-------------------------------------------------------
        '------- GRABA CABECERA
        GRABA_REGISTRO amovs_cab(), "IF4VALES", ctipo, 16, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'"
        '------- GRABA DETALLE
        cnn_dbbancos.Execute ("DELETE * FROM IF3VALES WHERE F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'")
        GRABA_REGISTRO_DET amovs_det(), "IF3VALES", "A", 11, cnn_dbbancos, "F4NUMVAL = '" & cnumvale & "' AND F2CODALM = '" & txtalmacen.Text & "'", Values(), nfil - 1, cvalores, cmes, "A"
    End If
    '-------------------------------------------------------
    '-------------------------------------------------------

End Sub

Private Sub ACTUALIZA_ALMA_VALE(pnumvale As String, pcampo As String, palmacen As String)
Dim csql    As String
        
    csql = "UPDATE EF2ALMACENES SET " & pcampo & " =  '" & pnumvale & "' WHERE '" & pnumvale & "' > " & pcampo & " AND F2CODALM='" & palmacen & "'"
    cnn_dbbancos.Execute csql
    
End Sub

Private Sub BUSCA_VALE(palmacen As String, pnumvale As String)
Dim ncontador       As Long
Dim cmedida         As String
Dim i               As Integer
Dim sw_nuevo_temp   As Boolean

    If rsif4vales.State = adStateOpen Then rsif4vales.Close
    rsif4vales.Open "SELECT * FROM IF4VALES WHERE F4NUMVAL = '" & pnumvale & "' AND F2CODALM = '" & palmacen & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsif4vales.EOF Then
        sw_nuevo_documento = False
        
        txtnumero.Text = pnumvale
        txtalmacen.Text = "" & rsif4vales.Fields("F2CODALM")
        For i = 0 To cmbalmacen.ListCount - 1
            If txtalmacen.Text = Right(cmbalmacen.List(i), 2) Then
                cmbalmacen.ListIndex = i
                Exit For
            End If
        Next
        
        abofecha.Value = Format(rsif4vales.Fields("F4FECVAL"), "DD/MM/YYYY")
        txtconcepto.Text = "" & rsif4vales.Fields("F1CODORI")
        If VALIDA_CONCEPTO_INV(txtconcepto.Text) = True Then
            If wpartida = "1" Then
                lblproveedor.Visible = True
                txtproveedor.Visible = True
                pnlproveedor.Visible = True
                cmdoc.Visible = True
            Else
                lblproveedor.Visible = False
                txtproveedor.Visible = False
                pnlproveedor.Visible = False
                cmdoc.Visible = False
            End If
        End If
        For i = 0 To cmbconcepto.ListCount - 1
            If txtconcepto.Text = Trim(Mid(cmbconcepto.List(i), 200)) Then
                cmbconcepto.ListIndex = i
                Exit For
            End If
        Next
        
        txttc.Text = Format(rsif4vales.Fields("F4TIPCAM"), "0.000")
        txtproveedor.Text = "" & rsif4vales.Fields("F2CODPROV")
        If Len(Trim(txtproveedor.Text)) > 0 Then
            If VALIDA_PROVEEDOR(txtproveedor.Text) = True Then
                pnlproveedor.Caption = wnomprov
            End If
        Else
            pnlproveedor.Caption = ""
        End If
        
        txtccosto.Text = "" & rsif4vales.Fields("F4CENTRO")
        If rsccosto.State = adStateOpen Then rsccosto.Close
        rsccosto.Open "SELECT F3DESCRIP FROM CENTROS WHERE F3COSTO='" & txtccosto.Text & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rsccosto.EOF Then
            pnlccosto.Caption = Trim("" & rsccosto.Fields("F3DESCRIP"))
        End If
        rsccosto.Close
            
        If "" & rsif4vales.Fields("F4MONEDA") = "S" Then
            cmbmoneda.ListIndex = 0
        Else
            cmbmoneda.ListIndex = 1
        End If
        
        txtserie.Text = "" & rsif4vales.Fields("F4SERGUIA")
        txtnumdoc.Text = "" & rsif4vales.Fields("F4NUMGUIA")
        txtobserva.Text = "" & rsif4vales.Fields("F4OBSERVA")
        
        If Len(Trim("" & rsif4vales.Fields("F4TIPDOC"))) > 0 Then
            For i = 0 To cmbtipo.ListCount
                If Right(cmbtipo.List(i), 2) = "" & rsif4vales.Fields("F4TIPDOC") Then
                    cmbtipo.ListIndex = i
                    Exit For
                End If
            Next
        Else
            cmbtipo.ListIndex = -1
        End If
        txtserfac.Text = "" & rsif4vales.Fields("F4SERDOC")
        txtnumfac.Text = "" & rsif4vales.Fields("F4NUMDOC")
        
        txtuupp.Text = rsif4vales.Fields("F4UUPP") & ""
        If VALIDA_UUPP(txtuupp.Text) = True Then
            pnluupp.Caption = wdeslocalidad
        End If
        
        '--------------------------------------------------
        If sw_nuevo_documento = False Then
            DELETEREC_N cnomtabla, cnn_form
            AdicionaItem
            sw_nuevo_documento = True
        End If
        
        dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
        dxDBGrid1.Dataset.Active = True
    
        dxDBGrid1.Dataset.Close
        dxDBGrid1.Dataset.Open
        
        dxDBGrid1.OptionEnabled = False
        dxDBGrid1.Dataset.DisableControls
        With dxDBGrid1.Dataset
            
            If rsif3vales.State = adStateOpen Then rsif3vales.Close
            rsif3vales.Open "SELECT * FROM IF3VALES WHERE F4NUMVAL = '" & pnumvale & "' AND F2CODALM = '" & palmacen & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
            If Not rsif3vales.EOF Then
                i = 1
                sw_nuevo_item = True
                rsif3vales.MoveFirst
                Do While Not rsif3vales.EOF
                    If sw_nuevo_temp = False Then
                        If sw_nuevo_documento = True Then
                            .Edit
                        Else
                            .Append
                        End If
                        sw_nuevo_temp = True
                    Else
                        .Append
                    End If
                    .FieldValues("ITEM") = i
                    .FieldValues("CODPROD") = rsif3vales.Fields("F5CODPRO") & ""
                    If rsif5pla.State = adStateOpen Then rsif5pla.Close
                    rsif5pla.Open "SELECT F5NOMPRO,F7CODMED,F5CODFAB, F5MARCA FROM IF5PLA WHERE F5CODPRO='" & rsif3vales.Fields("F5CODPRO") & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
                    If Not rsif5pla.EOF Then
                        .FieldValues("UMEDIDA") = "" & rsif5pla.Fields("F7CODMED")
                        .FieldValues("DESCRIPCION") = "" & rsif5pla.Fields("F5NOMPRO")
                        .FieldValues("CODFAB") = "" & rsif5pla.Fields("F5CODFAB")
                        .FieldValues("marca") = "" & rsif5pla.Fields("F5marca")
                    End If
                    rsif5pla.Close
                    .FieldValues("CANTIDAD") = Format(rsif3vales.Fields("F3CANPRO"), "###,###,##0.00")
                    If "" & rsif4vales.Fields("F4MONEDA") = "S" Then
                        .FieldValues("COSTOUNI") = Format(rsif3vales.Fields("F3VALVTA"), "###,###,##0.0000")
                        .FieldValues("IGV") = Format(rsif3vales.Fields("F3IGV"), "###,###,##0.00")
                        .FieldValues("TOTAL") = Format(rsif3vales.Fields("F3TOTITE"), "###,###,##0.00")
                    Else
                        .FieldValues("COSTOUNI") = Format(rsif3vales.Fields("F3VALDOL"), "###,###,##0.0000")
                        .FieldValues("IGV") = Format(rsif3vales.Fields("F3IGVDOL"), "###,###,##0.00")
                        .FieldValues("TOTAL") = Format(rsif3vales.Fields("F3TOTDOL"), "###,###,##0.00")
                    End If
                    rsif3vales.MoveNext
                    i = i + 1
                Loop
                .Post
                sw_nuevo_item = False
            End If
            rsif3vales.Close
            
        End With
        dxDBGrid1.Dataset.EnableControls
        dxDBGrid1.Dataset.Open
        dxDBGrid1.OptionEnabled = True
        '--------------------------------------------------
    Else
        '----- No existe
        sw_nuevo_documento = False
        nuevo
        AdicionaItem
        AdicionaItem
        sw_nuevo_documento = True
    End If
    rsif4vales.Close

End Sub

Private Sub elimina(pnumvale As String, palmacen As String)
On Error GoTo ERROR_ELIMINA
ReDim amovs(0 To 0) As a_grabacion
Dim cmes            As String * 2
Dim regAfec         As Integer

    If Len(Trim("" & txtnumero.Text)) = 0 Then
        MsgBox "El Vale de Ingreso no ha sido grabado. Verifique", vbCritical, "Atención"
        Exit Sub
    End If
    
    If MsgBox("Está seguro(a) de eliminar el Vale de Ingreso ?", vbYesNo + vbInformation, "Atención") = vbYes Then
        cnn_dbbancos.Execute ("DELETE * FROM IF4VALES WHERE F4NUMVAL = '" & pnumvale & "' AND F2CODALM = '" & palmacen & "'")
        cnn_dbbancos.Execute ("DELETE * FROM IF3VALES WHERE F4NUMVAL = '" & pnumvale & "' AND F2CODALM = '" & palmacen & "'")
        
        If wIndEnvia = "*" Then
            cnn_dbEnvia.Execute "delete from if4vales where f2codalm='" & palmacen & "' and f4numval='" & pnumvale & "'", regAfec
        
            If regAfec = 0 Then
                'vales
                'guardar el almacen,numvale en una tabla(de vales eliminados)
                'al recibir leer de esa tabla y ejecutar la setencia con los datos
                cnn_dbEnvia.Execute "insert into VALESELIMINADOS(F2CODALM, F4NUMVAL) " & _
                                    " values('" & palmacen & "','" & pnumvale & "')"
            End If
        End If
        
        nuevo
        AdicionaItem
    End If
    
    Exit Sub
    
ERROR_ELIMINA:
    MsgBox "Ha ocurrido el sgte. error " & Err.Description, vbCritical, "Atención"
    Resume Next
    
End Sub

Private Sub ACTUALIZA_CANT_OCOMPRA(pnumorden As Double)
Dim rstempo     As New ADODB.Recordset
    
    If rstempo.State = adStateOpen Then rstempo.Close
    rstempo.Open "SELECT * FROM " & cnomtabla & "", cnn_form, adOpenDynamic, adLockOptimistic
    If Not rstempo.EOF Then
        rstempo.MoveFirst
        Do While Not rstempo.EOF
            If Len(Trim(rstempo.Fields("CODPROD") & "")) > 0 Then
                cnn_dbbancos.Execute ("UPDATE IF3ORDEN SET F3CANFAL = F3CANFAL - " & rstempo.Fields("CANTIDAD") & " WHERE F4NUMORD=" & pnumorden & " AND F3CODPRO = '" & rstempo.Fields("CODPROD") & "'")
            End If
            rstempo.MoveNext
        Loop
    End If
    rstempo.Close

End Sub

Private Sub txtuupp_DblClick()

    txtuupp_KeyDown 113, 0
    
End Sub

Private Sub txtuupp_KeyDown(KeyCode As Integer, Shift As Integer)

    If KeyCode = 113 Then
        wcodlocalidad = "": wdeslocalidad = ""
        hlp_uupp.Show 1
        If Len(Trim(wcodlocalidad)) > 0 Then
            txtuupp.Text = Trim(wcodlocalidad)
            pnluupp.Caption = Trim(wdeslocalidad)
            txtuupp_KeyPress 13
        End If
    End If

End Sub

Private Sub txtuupp_KeyPress(KeyAscii As Integer)

    If KeyAscii = 13 Then
        txtserie.SetFocus
    End If

End Sub

Private Sub txtuupp_LostFocus()

    If Len(Trim(txtuupp.Text)) > 0 Then
        If VALIDA_UUPP(txtuupp.Text) = True Then
            pnluupp.Caption = wdeslocalidad
        Else
            MsgBox "Unidad de producción no existe", vbInformation + vbDefaultButton1, "Atención"
            txtuupp.Text = "": txtuupp.SetFocus
        End If
    End If

End Sub

Public Sub CargarMarca()
Dim rst As ADODB.Recordset

    Set rst = New ADODB.Recordset
    SQL = "select f2codmar, f2desmar from ef2marcas order by f2desmar"
    If rst.State = adStateOpen Then rst.Close
    rst.Open SQL, cnn_dbbancos, adOpenStatic, adLockOptimistic
    If Not rst.EOF Then
        cmbmarca.AddItem "** Todos **"
        Do While Not rst.EOF
            wmarca = Space(255)
            Mid(wmarca, 1) = rst!f2desmar
            Mid(wmarca, 200) = rst!f2codmar
            cmbmarca.AddItem wmarca
            rst.MoveNext
        Loop
        cmbmarca.ListIndex = 0
    End If
    rst.Close

End Sub

Private Sub BuscaImportacion(pimportacion As String)
Dim i                   As Integer
Dim sw_nuevo_temp       As Boolean

    sw_nuevo_temp = False
    If rst.State = adStateOpen Then rst.Close
    SQL = "SELECT IMPORT_CAB.*, IMPORT_DET.* " _
    & "FROM IMPORT_CAB INNER JOIN IMPORT_DET ON IMPORT_CAB.F4NumImp = IMPORT_DET.F4NumImp " _
    & "where import_cab.f4numimp='" & pimportacion & "'"
    rst.Open SQL, cnn_dbbancos, adOpenStatic, adLockOptimistic
    If Not rst.EOF Then
        With dxDBGrid1.Dataset
            dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
            dxDBGrid1.Dataset.Active = True
            
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
                    
            dxDBGrid1.OptionEnabled = False
            dxDBGrid1.Dataset.DisableControls
    
            sw_nuevo_item = True
            i = 1
            Do While Not rst.EOF
                If sw_nuevo_temp = False Then
                    sw_nuevo_temp = True
                    .Edit
                Else
                    .Append
                End If
                .FieldValues("ITEM") = i
                .FieldValues("CODPROD") = Trim("" & rst.Fields("F5CODPRO"))
                .FieldValues("CODFAB") = Trim("" & rst.Fields("F3CODFAB"))
        
                If rsif5pla.State = adStateOpen Then rsif5pla.Close
                rsif5pla.Open "SELECT F5NOMPRO,F7CODMED,f5marca FROM IF5PLA WHERE F5CODPRO = '" & Trim("" & rst.Fields("F5CODPRO")) & "'", cnn_dbbancos, adOpenStatic, adLockOptimistic
                If Not rsif5pla.EOF Then
                    .FieldValues("DESCRIPCION") = "" & rsif5pla.Fields("F5NOMPRO")
                    .FieldValues("UMEDIDA") = "" & rsif5pla.Fields("F7CODMED")
                    .FieldValues("marca") = "" & rsif5pla.Fields("f5marca")
                End If
                rsif5pla.Close
                wcantidad = Val("" & rst.Fields("F3CANTIDAD"))
                wcostouni = Val("" & rst.Fields("F3PREUNI"))
                xigv = (wcantidad * wcostouni) * (wigv / 100)
                wtot = wcantidad * wcostouni + xigv
                .FieldValues("CANTIDAD") = Format(Val("" & rst.Fields("F3CANTIDAD")), "###,##0.00")
                .FieldValues("COSTOUNI") = Format(Val("" & rst.Fields("F3PREUNI")), "###,##0.0000")
                .FieldValues("IGV") = Format(xigv, "###,##0.00")
                .FieldValues("TOTAL") = Format(wtot, "###,##0.00")
                i = i + 1
                rst.MoveNext
            Loop
            .Post
            dxDBGrid1.Dataset.EnableControls
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
            dxDBGrid1.OptionEnabled = True
            cmbconcepto.ListIndex = 7
        End With
    End If
    If rst.State = adStateOpen Then rst.Close

    Exit Sub
    sw_nuevo_temp = False
    If rsif4orden.State = adStateOpen Then rsif4orden.Close
    rsif4orden.Open "SELECT * FROM IF4ORDEN WHERE F4NUMORD = " & Val(pocompra) & "", cnn_dbbancos, adOpenDynamic, adLockOptimistic
    If Not rsif4orden.EOF Then
        '--------------------- C. COSTO
        txtccosto.Text = Trim("" & rsif4orden.Fields("F4CENTRO"))
        If rsccosto.State = adStateOpen Then rsccosto.Close
        rsccosto.Open "SELECT F3DESCRIP FROM CENTROS WHERE F3COSTO='" & txtccosto.Text & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rsccosto.EOF Then
            pnlccosto.Caption = Trim("" & rsccosto.Fields("F3DESCRIP"))
        End If
        rsccosto.Close
        '-----------------------------------------------------
        If Trim("" & rsif4orden.Fields("F4TIPMON")) = "S" Then
            cmbmoneda.ListIndex = 0
        ElseIf Trim("" & rsif4orden.Fields("F4TIPMON")) = "D" Then
            cmbmoneda.ListIndex = 1
        End If
        
        txtuupp.Text = rsif4orden.Fields("F4UUPP") & ""
        If VALIDA_UUPP(txtuupp.Text) = True Then
            pnluupp.Caption = wdeslocalidad
        End If
        
        If rsif3orden.State = adStateOpen Then rsif3orden.Close
        rsif3orden.Open "SELECT * FROM IF3ORDEN WHERE F4NUMORD = " & Val(pocompra) & " AND F3CANFAL > 0 ", cnn_dbbancos, adOpenDynamic, adLockOptimistic
        If Not rsif3orden.EOF Then
            dxDBGrid1.Dataset.ADODataset.ConnectionString = cnn_form
            dxDBGrid1.Dataset.Active = True
        
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
                        
            dxDBGrid1.OptionEnabled = False
            dxDBGrid1.Dataset.DisableControls
            With dxDBGrid1.Dataset
                i = 1
                sw_nuevo_item = True
                rsif3orden.MoveFirst
                Do While Not rsif3orden.EOF
                    If sw_nuevo_temp = False Then
                        sw_nuevo_temp = True
                        .Edit
                    Else
                        .Append
                    End If
                    .FieldValues("ITEM") = i
                    .FieldValues("CODPROD") = Trim("" & rsif3orden.Fields("F3CODPRO"))
                    .FieldValues("CODFAB") = Trim("" & rsif3orden.Fields("F3CODFAB"))
                    
                    If rsif5pla.State = adStateOpen Then rsif5pla.Close
                    rsif5pla.Open "SELECT F5NOMPRO,F7CODMED,f5marca FROM IF5PLA WHERE F5CODPRO = '" & Trim("" & rsif3orden.Fields("F3CODPRO")) & "'", cnn_dbbancos, adOpenDynamic, adLockOptimistic
                    If Not rsif5pla.EOF Then
                        .FieldValues("DESCRIPCION") = "" & rsif5pla.Fields("F5NOMPRO")
                        .FieldValues("UMEDIDA") = "" & rsif5pla.Fields("F7CODMED")
                        .FieldValues("marca") = "" & rsif5pla.Fields("f5marca")
                    End If
                    rsif5pla.Close
                    .FieldValues("CANTIDAD") = Format(Val("" & rsif3orden.Fields("F3CANFAL")), "###,##0.00")
                    .FieldValues("COSTOUNI") = Format(Val("" & rsif3orden.Fields("F3PRECOS")), "###,##0.0000")
                    .FieldValues("IGV") = Format(Val("" & rsif3orden.Fields("F3IGV")), "###,##0.00")
                    .FieldValues("TOTAL") = Format(Val("" & rsif3orden.Fields("F3TOTAL")), "###,##0.00")
                    rsif3orden.MoveNext
                    i = i + 1
                Loop
                .Post
                sw_nuevo_item = False
            End With
            dxDBGrid1.Dataset.EnableControls
            dxDBGrid1.Dataset.Close
            dxDBGrid1.Dataset.Open
            dxDBGrid1.OptionEnabled = True
        End If
        rsif3orden.Close
    End If
    rsif4orden.Close
    
End Sub
